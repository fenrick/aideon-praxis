name: Pipeline

on:
  push:
  pull_request:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      runSonar:
        description: 'Run SonarCloud analysis'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '24'
  PYTHON_VERSION: '3.13'
  YARN_VERSION: '4.10.3'

permissions:
  contents: read

concurrency:
  group: pipeline-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rust_checks:
    name: Rust Checks
    runs-on: ubuntu-latest
    # Minimal Rust gating (fmt/clippy) for packages/host only; no Tauri build yet.
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Rust (stable, fmt+clippy)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Cache Cargo & Target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            packages/host/target
          key: ${{ runner.os }}-rust-${{ hashFiles('packages/host/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-rust-

      - name: Generate lockfile (for audit & caching)
        working-directory: packages/host
        run: cargo generate-lockfile

      - name: Cargo fmt (check)
        working-directory: packages/host
        run: cargo fmt --all --check

      - name: Cargo clippy (deny warnings)
        working-directory: packages/host
        run: cargo clippy --all-targets -- -D warnings

      - name: Cargo check (typecheck)
        working-directory: packages/host
        run: cargo check --all-targets --all-features

      - name: Cargo test
        working-directory: packages/host
        run: cargo test --all --quiet

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Rust coverage (LCOV)
        working-directory: packages/host
        run: |
          mkdir -p coverage
          cargo llvm-cov --lcov --output-path coverage/lcov.info --all-targets

      - name: Clippy JSON report (for Sonar import)
        working-directory: packages/host
        run: |
          # Generate Clippy JSON without -D warnings (warnings already denied above)
          cargo clippy --message-format=json -q > coverage/clippy.json || true

      - name: Upload Rust coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-rs
          if-no-files-found: warn
          retention-days: 7
          path: |
            packages/host/coverage

      - name: Cache RustSec advisory DB
        uses: actions/cache@v4
        with:
          path: ~/.cargo/advisory-db
          key: ${{ runner.os }}-rust-advisorydb
          restore-keys: |
            ${{ runner.os }}-rust-advisorydb

      - name: Install cargo-audit (prebuilt)
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Cargo audit (advisories)
        working-directory: packages/host
        run: cargo audit -D warnings || (echo "[warn] cargo-audit failed; see advisories" && exit 1)

  js_checks:
    name: JS/TS Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack and Yarn ${{ env.YARN_VERSION }}
        run: |
          corepack enable
          corepack prepare yarn@${{ env.YARN_VERSION }} --activate

      - name: Cache Yarn
        uses: actions/cache@v4
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-yarn-

      - name: Install JS dependencies
        run: yarn install --immutable

      - name: JS Format Check
        run: yarn node:format:check

      - name: JS Lint
        run: yarn node:lint

      - name: JS Typecheck
        run: yarn node:typecheck

      - name: JS Tests + Coverage
        run: yarn node:test:coverage

      - name: Upload TS coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ts
          if-no-files-found: warn
          retention-days: 7
          path: |
            coverage/lcov.info

  py_checks:
    name: Python Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack and Yarn ${{ env.YARN_VERSION }}
        run: |
          corepack enable
          corepack prepare yarn@${{ env.YARN_VERSION }} --activate

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Yarn
        uses: actions/cache@v4
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-yarn-

      - name: Install JS dependencies (for Yarn run state)
        run: yarn install --immutable

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: latest

      - name: Cache uv and virtualenvs
        uses: actions/cache@v4
        with:
          path: |
            .venv
            packages/worker/.venv
            ~/.cache/uv
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-uv-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-uv-${{ env.PYTHON_VERSION }}-

      - name: Python Sync (uv) â€” worker venv
        run: yarn worker:sync

      - name: Python Lint (ruff+black --check)
        run: yarn worker:lint

      - name: Python Typecheck (mypy)
        run: yarn worker:typecheck

      - name: Python Typecheck (pyright)
        run: yarn worker:pyright

      - name: Python Security (bandit)
        run: yarn worker:sec

      - name: Python Dead code (vulture)
        run: yarn worker:deadcode

      - name: Python Tests + Coverage (pytest-cov)
        run: yarn worker:test:cov

      - name: Worker UDS Smoke (ping + state_at)
        shell: bash
        run: |
          set -euo pipefail
          rm -f .aideon/worker.sock || true
          # Start worker in background
          (AIDEON_WORKER_LOG=INFO yarn worker:serve >/tmp/worker.log 2>&1 &)
          # Wait for readiness
          for i in {1..100}; do
            if curl --unix-socket .aideon/worker.sock -sS http://localhost/ping | grep -q '"pong"'; then
              break
            fi
            sleep 0.1
          done
          echo "Ping OK"
          # Verify state_at endpoint
          curl --unix-socket .aideon/worker.sock -sS -H 'content-type: application/json' \
            -d '{"asOf":"2025-01-01"}' http://localhost/state_at | tee /tmp/state_at.json
          jq -e '.asOf=="2025-01-01" and .nodes==0 and .edges==0' /tmp/state_at.json >/dev/null
          echo "state_at OK"

      - name: Upload Python coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-py
          if-no-files-found: warn
          retention-days: 7
          path: packages/worker/coverage.xml

  sonar:
    name: SonarCloud
    runs-on: ubuntu-latest
    needs: [js_checks, py_checks, rust_checks]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.runSonar == true)
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download TS coverage
        uses: actions/download-artifact@v5
        with:
          name: coverage-ts
          path: coverage

      - name: Download Python coverage
        uses: actions/download-artifact@v5
        with:
          name: coverage-py
          path: packages/worker

      - name: Download Rust coverage
        uses: actions/download-artifact@v5
        with:
          name: coverage-rs
          path: packages/host/coverage

      - name: Normalize coverage paths
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p coverage packages/worker packages/host/coverage
          # TS coverage (downloaded directly to coverage/)
          if [[ -f coverage/lcov.info ]]; then
            echo "TS coverage at coverage/lcov.info"
          elif [[ -f coverage-ts/lcov.info ]]; then
            mv coverage-ts/lcov.info coverage/lcov.info
          elif [[ -f coverage-ts/coverage/lcov.info ]]; then
            mv coverage-ts/coverage/lcov.info coverage/lcov.info
          elif [[ -f lcov.info ]]; then
            mv lcov.info coverage/lcov.info
          else
            echo "[warn] TS coverage lcov.info not found after artifact download" >&2
          fi

          # Normalize/Filter TS LCOV: keep only project sources and repo-relative paths
          if [[ -f coverage/lcov.info ]]; then
            awk '
              function normalize(p) {
                gsub(/\\r$/, "", p);
                # strip runner absolute prefix -> repo root
                sub(/\/home\/runner\/work\/[^/]+\/[^/]+\//, "", p);
                sub(/^\/github\/workspace\//, "", p);
                return p;
              }
              /^SF:/ {
                path=$0; sub(/^SF:/, "", path);
                npath=normalize(path);
                keep=(npath ~ /^(packages\/app\/src|packages\/adapters\/src)\/.*\.(ts|tsx|js|jsx)$/);
                if (keep) {
                  print "SF:" npath;
                  in_file=1;
                } else {
                  in_file=0;
                }
                next;
              }
              { if (in_file==1) print $0 }
            ' coverage/lcov.info > coverage/lcov.filtered && mv coverage/lcov.filtered coverage/lcov.info
          fi

          # Python coverage (downloaded directly to packages/worker/)
          if [[ -f packages/worker/coverage.xml ]]; then
            echo "Py coverage at packages/worker/coverage.xml"
          elif [[ -f coverage-py/coverage.xml ]]; then
            mv coverage-py/coverage.xml packages/worker/coverage.xml
          elif [[ -f coverage.xml ]]; then
            mv coverage.xml packages/worker/coverage.xml
          elif [[ -f coverage-py/packages/worker/coverage.xml ]]; then
            mv coverage-py/packages/worker/coverage.xml packages/worker/coverage.xml
          else
            echo "[warn] Python coverage coverage.xml not found after artifact download" >&2
          fi
          # Rewrite Cobertura <source> to container mount so Sonar resolves paths cleanly
          if [[ -f packages/worker/coverage.xml ]]; then
            sed -i -E 's#<source>.*packages/worker/src</source>#<source>/github/workspace/packages/worker/src</source>#' packages/worker/coverage.xml || true
          fi

          # Rust coverage (LCOV -> Generic Coverage XML)
          # Locate the LCOV file from the artifact
          if [[ -f packages/host/coverage/lcov.info ]]; then
            echo "Rust lcov at packages/host/coverage/lcov.info"
          elif [[ -f coverage-rs/lcov.info ]]; then
            mv coverage-rs/lcov.info packages/host/coverage/lcov.info
          elif [[ -f coverage-rs/packages/host/coverage/lcov.info ]]; then
            mv coverage-rs/packages/host/coverage/lcov.info packages/host/coverage/lcov.info
          else
            echo "[warn] Rust coverage lcov.info not found after artifact download" >&2
          fi

          # Normalize Rust LCOV paths to repo-relative to help Sonar resolve files
          if [[ -f packages/host/coverage/lcov.info ]]; then
            sed -E 's#^(SF:)/home/runner/work/[^/]+/[^/]+/#+\1#; s#^(SF:)/github/workspace/#+\1#' \
              packages/host/coverage/lcov.info > packages/host/coverage/lcov.norm && \
              mv packages/host/coverage/lcov.norm packages/host/coverage/lcov.info
          fi

          # No Rust XML conversion required; Sonar ingests LCOV directly via sonar.rust.lcov.reportPaths
          ls -l coverage || true
          ls -l packages/worker || true
          ls -l packages/host/coverage || true

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
