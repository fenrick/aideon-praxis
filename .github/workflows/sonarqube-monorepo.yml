name: SonarQube Monorepo

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: sonarqube-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  sonarqube:
    name: SonarQube monorepo scan
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '24'
      PNPM_VERSION: '10.19.0'
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' &&
        github.event.pull_request.head.repo.full_name == github.event.pull_request.base.repo.full_name)
    defaults:
      run:
        working-directory: .
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Capture pnpm store path
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> "$GITHUB_OUTPUT"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: pnpm-${{ runner.os }}-node-${{ env.NODE_VERSION }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-node-${{ env.NODE_VERSION }}-pnpm-

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Node coverage
        run: pnpm run node:test:coverage

      - name: Verify Node coverage report
        run: test -f coverage/lcov.info

      - name: Install Linux GUI deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config libglib2.0-dev libgtk-3-dev libayatana-appindicator3-dev \
            librsvg2-dev libwebkit2gtk-4.1-dev libsoup-3.0-dev

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: cargo-registry-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-registry-${{ runner.os }}-

      - name: Cache Cargo git
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: cargo-git-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-git-${{ runner.os }}-

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy, llvm-tools-preview

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked

      - name: Run Rust coverage
        run: pnpm run host:coverage

      - name: Verify Rust coverage report
        run: test -f coverage/rust.lcov

      - name: Rust toolchain diagnostics
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          echo "rustc: $(rustc -Vv)"
          echo "cargo: $(cargo -V)"
          echo "rustup: $(rustup -V)"
          echo "installed components:"
          rustup component list --installed | sort
          echo "workspace metadata:"
          cargo metadata --format-version 1 --no-deps > /dev/null
          echo "coverage directory:"
          ls -la coverage || true

      - name: Ensure coverage directory exists
        shell: bash
        run: mkdir -p coverage

      - name: Run SonarQube scan
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Sonar's Clippy sensor runs `cargo clippy`; avoid inheriting repo/runner
          # defaults that turn all warnings into hard errors and fail with exit code 101.
          RUSTFLAGS: ''
        with:
          args: >
            -Dsonar.verbose=false

      - name: Collect Sonar scanner metadata
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          echo "=== .scannerwork/report-task.txt ==="
          if [[ -f .scannerwork/report-task.txt ]]; then
            cat .scannerwork/report-task.txt
          else
            echo "[warn] .scannerwork/report-task.txt not found"
          fi
          echo "=== .scannerwork contents (top-level) ==="
          ls -la .scannerwork || true

      - name: Upload Sonar scanner metadata
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: sonar-scanner-metadata
          path: |
            .scannerwork/report-task.txt
          if-no-files-found: ignore
